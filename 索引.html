<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ™ºæ…§è¾²å ´é ç«¯ç›£æ§é¢æ¿</title>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; background:#f0f8ff; text-align:center; padding:30px; margin:0; }
    h1 { color:#333; }
    .data-block { font-size:20px; margin:10px 0; }
    button {
      font-size:18px; padding:10px 20px; margin:10px 5px; cursor:pointer;
      border:none; border-radius:5px; background:#4CAF50; color:#fff;
      transition:background-color 0.3s ease;
    }
    button:hover:not(:disabled) { background:#45a049; }
    button:disabled { background:#ccc; color:#666; cursor:not-allowed; }
    .status { font-weight:bold; }
    .charts {
      display:flex; justify-content:center; gap:20px; flex-wrap:wrap; margin-top:20px;
    }
    .charts iframe {
      border:1px solid #ccc; flex:1 1 300px; max-width:450px; height:260px;
    }
  </style>
</head>
<body>
  <h1>ğŸŒ± æ™ºæ…§è¾²å ´æº«æ¿•åœŸé ç«¯ç›£æ§é¢æ¿</h1>

  <div class="data-block">ğŸ“¡ è£ç½®ç‹€æ…‹ï¼š<span id="deviceStatus" class="status">è®€å–ä¸­...</span></div>
  <div class="data-block">ğŸ•’ æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š<span id="lastUpdate" class="status">è®€å–ä¸­...</span></div>
  <div class="data-block">
    <button id="btnToggleMode">åˆ‡æ›æ¨¡å¼</button> ç›®å‰æ¨¡å¼ï¼š<span id="modeStatus" class="status">è®€å–ä¸­...</span>
  </div>
  <div class="data-block">
    <button id="btnToggleRelay">åˆ‡æ›ç¹¼é›»å™¨</button> ç¹¼é›»å™¨ç‹€æ…‹ï¼š<span id="relayStatus" class="status">è®€å–ä¸­...</span>
  </div>
  <div class="data-block">ğŸŒ¡ï¸ æº«åº¦ï¼š<span id="temperature">è®€å–ä¸­...</span></div>
  <div class="data-block">ğŸ’§ æ¿•åº¦ï¼š<span id="humidity">è®€å–ä¸­...</span></div>
  <div class="data-block">ğŸŒ¾ åœŸå£¤æ¿•åº¦ï¼š<span id="soil">è®€å–ä¸­...</span></div>

  <h2>ğŸ“ˆ æ­·å²è³‡æ–™åœ–è¡¨</h2>
  <div class="charts">
    <iframe src="https://thingspeak.com/channels/2925557/charts/1?api_key=LZOID244VPGKMRMA&bgcolor=%23ffffff&color=%23d62020&dynamic=true&type=line&title=æº«åº¦" loading="lazy" referrerpolicy="no-referrer"></iframe>
    <iframe src="https://thingspeak.com/channels/2925557/charts/2?api_key=LZOID244VPGKMRMA&bgcolor=%23ffffff&color=%230096ff&dynamic=true&type=line&title=æ¿•åº¦" loading="lazy" referrerpolicy="no-referrer"></iframe>
    <iframe src="https://thingspeak.com/channels/2925557/charts/3?api_key=LZOID244VPGKMRMA&bgcolor=%23ffffff&color=%2399cc00&dynamic=true&type=line&title=åœŸå£¤æ¿•åº¦" loading="lazy" referrerpolicy="no-referrer"></iframe>
  </div>

<script>
  const blynkToken = "o_yKGcjAjDNAqxEVN-z5w3bFjVcn6skl";
  const thingspeakChannel = "2925557";
  const thingspeakApiKey = "LZOID244VPGKMRMA";

  let mode = 1; // 1=è‡ªå‹•, 0=æ‰‹å‹•
  let relayState = 0;

  const deviceStatusEl = document.getElementById("deviceStatus");
  const lastUpdateEl = document.getElementById("lastUpdate");
  const modeStatusEl = document.getElementById("modeStatus");
  const relayStatusEl = document.getElementById("relayStatus");
  const tempEl = document.getElementById("temperature");
  const humidityEl = document.getElementById("humidity");
  const soilEl = document.getElementById("soil");

  const btnToggleMode = document.getElementById("btnToggleMode");
  const btnToggleRelay = document.getElementById("btnToggleRelay");

  async function getV(pin) {
    try {
      const url = `https://blynk.cloud/external/api/get?token=${blynkToken}&V${pin}`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`Fetch V${pin} failed: ${resp.status}`);
      return (await resp.text()).trim();
    } catch (e) {
      console.error(e);
      throw e;
    }
  }

  async function setV(pin, val) {
    try {
      const url = `https://blynk.cloud/external/api/update?token=${blynkToken}&V${pin}=${val}`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`Set V${pin} failed: ${resp.status}`);
    } catch (e) {
      console.error(e);
      throw e;
    }
  }

  async function updateRelayStatus() {
    try {
      relayState = parseInt(await getV(0));
      relayStatusEl.innerText = relayState === 1 ? "é–‹å•Ÿ" : "é—œé–‰";
      relayStatusEl.style.color = relayState === 1 ? "green" : "red";

      if (mode === 0) {
        btnToggleRelay.disabled = false;
        btnToggleRelay.innerText = relayState === 1 ? "é—œé–‰æ¾†æ°´" : "é–‹å•Ÿæ¾†æ°´";
      } else {
        btnToggleRelay.disabled = true;
        btnToggleRelay.innerText = "è‡ªå‹•æ¨¡å¼ä¸­ä¸å¯æ§åˆ¶";
      }
    } catch {
      relayStatusEl.innerText = "éŒ¯èª¤";
      relayStatusEl.style.color = "gray";
      btnToggleRelay.disabled = true;
    }
  }

  async function updateModeStatus() {
    try {
      mode = parseInt(await getV(4));
      modeStatusEl.innerText = mode === 1 ? "è‡ªå‹•" : "æ‰‹å‹•";
      modeStatusEl.style.color = mode === 1 ? "green" : "orange";
      await updateRelayStatus();
    } catch {
      modeStatusEl.innerText = "éŒ¯èª¤";
      modeStatusEl.style.color = "gray";
    }
  }

  async function toggleMode() {
    try {
      mode = mode === 1 ? 0 : 1;
      await setV(4, mode);
      await updateModeStatus();
    } catch (e) {
      alert("åˆ‡æ›æ¨¡å¼å¤±æ•—ï¼š" + e.message);
    }
  }

  async function toggleRelay() {
    if (mode === 1) {
      alert("è‡ªå‹•æ¨¡å¼ä¸­ç„¡æ³•æ‰‹å‹•åˆ‡æ›!");
      return;
    }
    try {
      relayState = relayState === 1 ? 0 : 1;
      await setV(0, relayState);
      await updateRelayStatus();
    } catch (e) {
      alert("åˆ‡æ›ç¹¼é›»å™¨å¤±æ•—ï¼š" + e.message);
    }
  }

  async function updateDeviceStatus() {
    try {
      const url = `https://blynk.cloud/external/api/isHardwareConnected?token=${blynkToken}`;
      const resp = await fetch(url);
      const txt = await resp.text();
      const online = txt === "true";
      deviceStatusEl.innerText = online ? "åœ¨ç·š" : "é›¢ç·š";
      deviceStatusEl.style.color = online ? "green" : "red";
    } catch {
      deviceStatusEl.innerText = "éŒ¯èª¤";
      deviceStatusEl.style.color = "gray";
    }
  }

  async function fetchSensorData() {
    try {
      const url = `https://api.thingspeak.com/channels/${thingspeakChannel}/feeds/last.json?api_key=${thingspeakApiKey}`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`ThingSpeak å–å¾—è³‡æ–™å¤±æ•—ï¼š${resp.status}`);
      const data = await resp.json();

      tempEl.innerText = data.field1 ? `${data.field1} Â°C` : "ç„¡è³‡æ–™";
      humidityEl.innerText = data.field2 ? `${data.field2} %` : "ç„¡è³‡æ–™";
      soilEl.innerText = data.field3 ? `${data.field3} %` : "ç„¡è³‡æ–™";

      lastUpdateEl.innerText = data.created_at
        ? new Date(data.created_at).toLocaleString()
        : "ç„¡è³‡æ–™";
    } catch (e) {
      console.error(e);
      tempEl.innerText = humidityEl.innerText = soilEl.innerText = "éŒ¯èª¤";
      lastUpdateEl.innerText = "éŒ¯èª¤";
    }
  }

  async function refreshAll() {
    await Promise.all([
      updateDeviceStatus(),
      updateModeStatus(),
      fetchSensorData(),
    ]);
  }

  btnToggleMode.addEventListener("click", toggleMode);
  btnToggleRelay.addEventListener("click", toggleRelay);

  // é é¢è¼‰å…¥æ™‚å…ˆåˆ·æ–°ä¸€æ¬¡è³‡æ–™
  refreshAll();

  // æ¯ 30 ç§’åˆ·æ–°è³‡æ–™
  setInterval(refreshAll, 30000);
</script>
</body>
</html>
